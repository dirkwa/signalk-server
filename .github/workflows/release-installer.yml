name: 'Build Installer'

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.19.0)'
        required: false
        default: ''

jobs:
  build-installer:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            args: ''
          - platform: 'ubuntu-22.04'
            target: 'aarch64-unknown-linux-gnu'
            args: ''
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            args: '--target x86_64-apple-darwin'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            args: '--target aarch64-apple-darwin'
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      # Linux ARM64 cross-compilation setup
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libudev-dev imagemagick

      # macOS dependencies (for icon generation)
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install imagemagick

      # Windows dependencies (for icon generation)
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: choco install imagemagick

      # Generate app icons
      - name: Generate app icons
        working-directory: packages/installer
        shell: bash
        run: bash scripts/generate-icons.sh

      - name: Install npm dependencies
        working-directory: packages/installer
        run: npm install

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@2

      - name: Build the app
        working-directory: packages/installer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            export PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          npm run tauri:build -- ${{ matrix.args }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signalk-installer-${{ matrix.target }}
          path: |
            packages/installer/src-tauri/target/*/release/bundle/**/*.deb
            packages/installer/src-tauri/target/*/release/bundle/**/*.deb.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.AppImage
            packages/installer/src-tauri/target/*/release/bundle/**/*.AppImage.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.dmg
            packages/installer/src-tauri/target/*/release/bundle/**/*.dmg.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.msi
            packages/installer/src-tauri/target/*/release/bundle/**/*.msi.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.nsis.zip
            packages/installer/src-tauri/target/*/release/bundle/**/*.nsis.zip.sig
            packages/installer/src-tauri/target/release/bundle/**/*.deb
            packages/installer/src-tauri/target/release/bundle/**/*.deb.sig
            packages/installer/src-tauri/target/release/bundle/**/*.AppImage
            packages/installer/src-tauri/target/release/bundle/**/*.AppImage.sig
            packages/installer/src-tauri/target/release/bundle/**/*.dmg
            packages/installer/src-tauri/target/release/bundle/**/*.dmg.sig
            packages/installer/src-tauri/target/release/bundle/**/*.msi
            packages/installer/src-tauri/target/release/bundle/**/*.msi.sig
            packages/installer/src-tauri/target/release/bundle/**/*.nsis.zip
            packages/installer/src-tauri/target/release/bundle/**/*.nsis.zip.sig

      # Upload to release (only on release event)
      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/installer/src-tauri/target/*/release/bundle/**/*.deb
            packages/installer/src-tauri/target/*/release/bundle/**/*.deb.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.AppImage
            packages/installer/src-tauri/target/*/release/bundle/**/*.AppImage.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.dmg
            packages/installer/src-tauri/target/*/release/bundle/**/*.dmg.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.msi
            packages/installer/src-tauri/target/*/release/bundle/**/*.msi.sig
            packages/installer/src-tauri/target/*/release/bundle/**/*.nsis.zip
            packages/installer/src-tauri/target/*/release/bundle/**/*.nsis.zip.sig
            packages/installer/src-tauri/target/release/bundle/**/*.deb
            packages/installer/src-tauri/target/release/bundle/**/*.deb.sig
            packages/installer/src-tauri/target/release/bundle/**/*.AppImage
            packages/installer/src-tauri/target/release/bundle/**/*.AppImage.sig
            packages/installer/src-tauri/target/release/bundle/**/*.dmg
            packages/installer/src-tauri/target/release/bundle/**/*.dmg.sig
            packages/installer/src-tauri/target/release/bundle/**/*.msi
            packages/installer/src-tauri/target/release/bundle/**/*.msi.sig
            packages/installer/src-tauri/target/release/bundle/**/*.nsis.zip
            packages/installer/src-tauri/target/release/bundle/**/*.nsis.zip.sig
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Generate latest.json for auto-updater after all builds complete
  generate-update-manifest:
    needs: build-installer
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate latest.json
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}"

          # Find signature files and read their contents
          find_sig() {
            local pattern=$1
            local sig_file=$(find artifacts -name "${pattern}.sig" 2>/dev/null | head -1)
            if [ -f "$sig_file" ]; then
              cat "$sig_file"
            else
              echo ""
            fi
          }

          # Find artifact filename
          find_artifact() {
            local pattern=$1
            find artifacts -name "$pattern" ! -name "*.sig" 2>/dev/null | head -1 | xargs -r basename
          }

          # Get signatures
          LINUX_X64_DEB=$(find_artifact "*amd64.deb")
          LINUX_X64_DEB_SIG=$(find_sig "*amd64.deb")
          LINUX_X64_APPIMAGE=$(find_artifact "*amd64.AppImage")
          LINUX_X64_APPIMAGE_SIG=$(find_sig "*amd64.AppImage")
          LINUX_ARM64_DEB=$(find_artifact "*arm64.deb")
          LINUX_ARM64_DEB_SIG=$(find_sig "*arm64.deb")
          MACOS_X64_DMG=$(find_artifact "*x64.dmg")
          MACOS_X64_DMG_SIG=$(find_sig "*x64.dmg")
          MACOS_ARM64_DMG=$(find_artifact "*aarch64.dmg")
          MACOS_ARM64_DMG_SIG=$(find_sig "*aarch64.dmg")
          WINDOWS_MSI=$(find_artifact "*.msi")
          WINDOWS_MSI_SIG=$(find_sig "*.msi")
          WINDOWS_NSIS=$(find_artifact "*.nsis.zip")
          WINDOWS_NSIS_SIG=$(find_sig "*.nsis.zip")

          # Generate latest.json
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "SignalK Server Installer v$VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "url": "$RELEASE_URL/$LINUX_X64_APPIMAGE",
                "signature": "$LINUX_X64_APPIMAGE_SIG"
              },
              "linux-aarch64": {
                "url": "$RELEASE_URL/$LINUX_ARM64_DEB",
                "signature": "$LINUX_ARM64_DEB_SIG"
              },
              "darwin-x86_64": {
                "url": "$RELEASE_URL/$MACOS_X64_DMG",
                "signature": "$MACOS_X64_DMG_SIG"
              },
              "darwin-aarch64": {
                "url": "$RELEASE_URL/$MACOS_ARM64_DMG",
                "signature": "$MACOS_ARM64_DMG_SIG"
              },
              "windows-x86_64": {
                "url": "$RELEASE_URL/$WINDOWS_NSIS",
                "signature": "$WINDOWS_NSIS_SIG"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat latest.json

      - name: Upload latest.json to release
        uses: softprops/action-gh-release@v1
        with:
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
